<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ClipCheck - Reddit Misinformation Detection</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>ClipCheck — Reddit Misinformation Detection</h1>
    <p>Enter a hashtag to search Reddit posts and analyze them for potential misinformation. The tool will return the top 10 posts ranked by Google search, each with a misinformation likelihood score.</p>

    <form id="analyzeForm">
      <input id="hashtag" name="hashtag" placeholder="Enter hashtag (e.g., #cyberpunk or cyberpunk)" />
      <button type="submit">Analyze</button>
    </form>

    <div id="loading" class="card" style="display:none;">
      <p>⏳ Scraping Reddit posts, training model, and analyzing... This may take 20-30 seconds.</p>
      <small style="color: #666;">Steps: Scraping your hashtag → Scraping training data → Training ML model → Predicting scores</small>
    </div>

    <div id="result" class="card" style="display:none;">
      <h2>Analysis Results for <span id="hashtag-display"></span></h2>

      <div id="statistics" class="stats-box"></div>

      <h3>Top 10 Posts (Ranked by Google Search)</h3>
      <div id="posts-list"></div>
    </div>

    <div id="error" class="card error" style="display:none;"></div>
  </div>

<script>
document.getElementById('analyzeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const hashtag = document.getElementById('hashtag').value.trim();
  if (!hashtag) return alert('Please enter a hashtag');

  document.getElementById('error').style.display='none';
  document.getElementById('result').style.display='none';
  document.getElementById('loading').style.display='block';

  try {
    const resp = await fetch('/analyze', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({hashtag})
    });

    const data = await resp.json();
    document.getElementById('loading').style.display='none';

    if (!resp.ok) {
      document.getElementById('error').textContent = data.error || 'Unknown error';
      document.getElementById('error').style.display='block';
      return;
    }

    // Display hashtag and statistics
    document.getElementById('hashtag-display').textContent = data.hashtag;

    const stats = data.statistics;
    document.getElementById('statistics').innerHTML = `
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-label">Total Posts</div>
          <div class="stat-value">${data.total_posts}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Avg Score</div>
          <div class="stat-value">${stats.avg_misinfo_score}%</div>
        </div>
        <div class="stat-item high-risk">
          <div class="stat-label">High Risk</div>
          <div class="stat-value">${stats.high_risk_count}</div>
        </div>
        <div class="stat-item medium-risk">
          <div class="stat-label">Medium Risk</div>
          <div class="stat-value">${stats.medium_risk_count}</div>
        </div>
        <div class="stat-item low-risk">
          <div class="stat-label">Low Risk</div>
          <div class="stat-value">${stats.low_risk_count}</div>
        </div>
      </div>
    `;

    // Display posts
    let postsHtml = '';
    data.posts.forEach(post => {
      const riskClass = post.risk_level;
      const riskLabel = post.risk_level.toUpperCase();
      const keywordsHtml = post.keywords.length > 0
        ? `<div class="keywords"><strong>Keywords:</strong> ${post.keywords.join(', ')}</div>`
        : '';

      postsHtml += `
        <div class="post-card ${riskClass}">
          <div class="post-header">
            <span class="rank">#${post.rank}</span>
            <span class="risk-badge ${riskClass}">${riskLabel} RISK</span>
            <span class="score">${post.misinfo_score}%</span>
          </div>
          <h4><a href="${post.url}" target="_blank">${post.title}</a></h4>
          <div class="post-meta">
            <span>r/${post.subreddit}</span>
            ${post.date ? ` • <span>${post.date}</span>` : ''}
          </div>
          <p class="snippet">${post.snippet}</p>
          ${keywordsHtml}
          <div class="post-details">
            <small>Clickbait score: ${post.clickbait_score}</small>
          </div>
        </div>
      `;
    });

    document.getElementById('posts-list').innerHTML = postsHtml;
    document.getElementById('result').style.display='block';

  } catch (error) {
    document.getElementById('loading').style.display='none';
    document.getElementById('error').textContent = 'Network error: ' + error.message;
    document.getElementById('error').style.display='block';
  }
});
</script>
</body>
</html>
